name: Nightly — dbt Docs (Base & Pro)

permissions:
  contents: write

on:
  schedule:
    - cron: '0 5 * * *'   # ~midnight ET
  workflow_dispatch:

concurrency:
  group: pages-deploy
  cancel-in-progress: true

jobs:
  nightly:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      DBT_PROFILES_DIR: ./.ci/profiles
      SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
      SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
      SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
      SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
      SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Remove stale package lock (if any)
        run: rm -f package-lock.yml

      - name: Authenticate Git for private deps (conditional)
        if: ${{ secrets.PRO_GH_PAT != '' }}
        run: |
          git config --global url."https://${{ secrets.PRO_GH_PAT }}:@github.com/".insteadOf "https://github.com/"

      - name: Select package set (Base or Pro)
        run: |
          if [ -n "${{ secrets.PRO_GH_PAT }}" ]; then
            cp packages.pro.yml packages.yml
            echo "Using Pro package set for docs (authorized)."
            echo 'DOCS_VARIANT=pro' >> "$GITHUB_ENV"
            echo 'DBT_DOCS_VARS={"enable_pro_pack": true, "DEMO_MODE": false, "snowflake_finops_pro": {"enable_pro_pack": true}}' >> "$GITHUB_ENV"
          else
            cp packages.base.yml packages.yml
            echo "Using Base package set for docs (no Pro auth)."
            echo 'DOCS_VARIANT=base' >> "$GITHUB_ENV"
            echo 'DBT_DOCS_VARS={"enable_pro_pack": false, "DEMO_MODE": false}' >> "$GITHUB_ENV"
          fi

      - name: dbt deps
        run: dbt deps

      - name: Generate docs (with fallback)
        run: |
          set -e
          rm -rf docs_stub
          mkdir -p docs_stub
          VARIANT="${DOCS_VARIANT:-base}"
          TARGET_PATH="target/${VARIANT}"
          rm -rf "$TARGET_PATH"
          mkdir -p "$TARGET_PATH"
          if dbt docs generate \
            --profiles-dir ${{ env.DBT_PROFILES_DIR }} \
            --target prod \
            --target-path "$TARGET_PATH" \
            --vars "${DBT_DOCS_VARS}" \
            --exclude tag:backlog \
            --exclude source:account_usage_backlog \
            --exclude fqn:metering_demo_seed,resource_type:seed \
            --exclude fqn:metering_overlay,resource_type:model; then
            echo "Docs generated."
          else
            echo "dbt docs failed; using stub docs."
            printf "<h2>Docs temporarily unavailable</h2><p>Build fallback</p>" > docs_stub/index.html
          fi

      - name: Upload docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: dbt-docs
          path: |
            target/**
            docs_stub/**

      - name: Build static site (index + subdirs)
        run: |
          set -e
          rm -rf site
          mkdir -p site
          had_docs=0
          for variant in base pro; do
            if [ -f "target/${variant}/index.html" ]; then
              mkdir -p "site/${variant}"
              cp -r "target/${variant}"/* "site/${variant}/"
              had_docs=1
            fi
          done
          if [ "$had_docs" -eq 1 ]; then
            {
              echo '<!doctype html><meta charset="utf-8"><title>finops-dbt docs</title>'
              echo '<style>body{font-family:ui-sans-serif,system-ui,-apple-system;max-width:720px;margin:40px auto;padding:0 16px}a{display:block;margin:12px 0;font-size:18px}</style>'
              echo '<h1>finops-dbt — documentation (nightly)</h1>'
              if [ -d site/base ]; then
                echo '<a href="base/index.html">Base (Starter)</a>'
              fi
              if [ -d site/pro ]; then
                echo '<a href="pro/index.html">Pro (Starter + Pro Pack)</a>'
              fi
            } > site/index.html
          else
            if [ -f docs_stub/index.html ]; then
              cp docs_stub/index.html site/index.html
            else
              printf '<h2>Docs temporarily unavailable</h2><p>Build fallback</p>' > site/index.html
            fi
          fi

      - name: Publish to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
