name: PR â€” Compile & docs artifact

permissions:
  contents: read

on:
  pull_request:
  workflow_dispatch:

concurrency:
  group: pr-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    timeout-minutes: 20
    env:
      DBT_PROFILES_DIR: ./.ci/profiles
      PRO_GH_PAT: ${{ secrets.PRO_GH_PAT }}
      # Use real Snowflake creds when available (first-party PRs)
      SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
      SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
      SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
      SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
      SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Remove stale package lock (if any)
        run: rm -f package-lock.yml

      - name: Authenticate Git for private deps (conditional)
        if: ${{ env.PRO_GH_PAT != '' }}
        run: |
          git config --global url."https://${PRO_GH_PAT}:@github.com/".insteadOf "https://github.com/"

      - name: dbt deps (skip if no packages.yml)
        if: hashFiles('packages.yml') != ''
        run: dbt deps

      - name: dbt parse (manifest only)
        run: >
          dbt parse
          --profiles-dir ${{ env.DBT_PROFILES_DIR }}

      - name: Compile (demo target)
        run: >
          dbt compile
          --profiles-dir ${{ env.DBT_PROFILES_DIR }}
          --target demo
          --vars '{"enable_pro_pack": false, "DEMO_MODE": true}'
          --fail-fast

      - name: dbt test (state:modified+)
        run: |
          dbt deps
          dbt compile
          dbt test --select state:modified+ --defer --state target

      - name: Upload dbt artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dbt-target
          path: target/**

      - name: Check if Snowflake secrets are available
        id: has_secrets
        run: |
          if [[ -n "${{ secrets.SNOWFLAKE_ACCOUNT }}" && -n "${{ secrets.SNOWFLAKE_USER }}" && -n "${{ secrets.SNOWFLAKE_PASSWORD }}" ]]; then
            echo "available=true" >> "$GITHUB_OUTPUT"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Source freshness (live)
        if: steps.has_secrets.outputs.available == 'true'
        run: >
          dbt source freshness
          --profiles-dir ${{ env.DBT_PROFILES_DIR }}
          --target live
          --output json > freshness.json

      - name: Fail on freshness errors (jq)
        if: steps.has_secrets.outputs.available == 'true'
        run: |
          if [[ ! -f freshness.json ]]; then
            echo "freshness.json missing"; exit 1
          fi
          # Fail if any result has status == "error"
          if jq -e '.results[] | select(.status=="error")' freshness.json >/dev/null; then
            echo "Freshness errors detected for:"
            jq -r '.results[] | select(.status=="error") | .unique_id' freshness.json
            exit 1
          fi

      - name: Generate docs (with fallback)
        run: |
          set -e
          rm -rf docs_stub
          mkdir -p docs_stub
          if dbt docs generate \
            --profiles-dir ${{ env.DBT_PROFILES_DIR }} \
            --target live \
            --vars '{"enable_pro_pack": false, "DEMO_MODE": false}' \
            --exclude tag:backlog \
            --exclude source:account_usage_backlog \
            --exclude fqn:metering_demo_seed,resource_type:seed \
            --exclude fqn:metering_overlay,resource_type:model; then
            echo "Docs generated."
          else
            echo "dbt docs failed; using stub docs."
            printf "<h2>Docs temporarily unavailable</h2><p>Build fallback</p>" > docs_stub/index.html
          fi

      - name: Upload docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: dbt-docs
          path: |
            target/**
            docs_stub/**
