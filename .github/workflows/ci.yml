name: PR â€” Compile & docs artifact

permissions:
  contents: read

on:
  pull_request:
  workflow_dispatch:

concurrency:
  group: pr-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    timeout-minutes: 20
    env:
      DBT_PROFILES_DIR: ./.ci/profiles
      PRO_REPO_TOKEN: ${{ secrets.PRO_REPO_TOKEN }}
      # Use real Snowflake creds when available (first-party PRs)
      SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
      SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
      SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
      SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
      SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Remove stale package lock (if any)
        run: rm -f package-lock.yml

      - name: dbt deps (skip if no packages.yml)
        if: hashFiles('packages.yml') != ''
        run: dbt deps

      - name: dbt parse (manifest only)
        run: >
          dbt parse
          --profiles-dir ${{ env.DBT_PROFILES_DIR }}

      - name: Compile (demo target)
        run: >
          dbt compile
          --profiles-dir ${{ env.DBT_PROFILES_DIR }}
          --target demo
          --vars '{"enable_pro_pack": false, "DEMO_MODE": true}'
          --fail-fast

      - name: Check if Snowflake secrets are available
        id: has_secrets
        run: |
          if [[ -n "${{ secrets.SNOWFLAKE_ACCOUNT }}" && -n "${{ secrets.SNOWFLAKE_USER }}" && -n "${{ secrets.SNOWFLAKE_PASSWORD }}" ]]; then
            echo "available=true" >> "$GITHUB_OUTPUT"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Source freshness (live)
        if: steps.has_secrets.outputs.available == 'true'
        run: >
          dbt source freshness
          --profiles-dir ${{ env.DBT_PROFILES_DIR }}
          --target live
          --output json > freshness.json

      - name: Fail on freshness errors
        if: steps.has_secrets.outputs.available == 'true'
        run: |
          python -c "import json, sys; from pathlib import Path; payload = Path('freshness.json')
if not payload.exists():
    sys.exit('freshness.json missing')
data = json.loads(payload.read_text())
errors = [r for r in data.get('results', []) if r.get('status') == 'error']
if errors:
    failing = ', '.join(r.get('unique_id', 'unknown') for r in errors)
    sys.exit(f'Freshness errors detected: {failing}')"

      - name: Generate docs (live)
        if: steps.has_secrets.outputs.available == 'true'
        run: >
          dbt docs generate
          --profiles-dir ${{ env.DBT_PROFILES_DIR }}
          --target live
          --vars '{"enable_pro_pack": false, "DEMO_MODE": false}'
          --exclude tag:backlog
          --exclude source:account_usage_backlog
          --exclude fqn:metering_demo_seed,resource_type:seed
          --exclude fqn:metering_overlay,resource_type:model

      - name: Package docs artifact (with secrets)
        if: steps.has_secrets.outputs.available == 'true'
        run: |
          set -euo pipefail
          files=(target/manifest.json target/catalog.json target/index.html)
          [[ -f target/run_results.json ]] && files+=("target/run_results.json")
          [[ -d target/compiled ]] && files+=("target/compiled")
          tar -czf dbt-docs.tar.gz "${files[@]}"

      - name: Prepare fallback docs artifact (no secrets)
        if: steps.has_secrets.outputs.available != 'true'
        run: |
          set -euo pipefail
          mkdir -p target
          [[ -f target/manifest.json ]] || { echo "manifest.json missing; ensure dbt parse/compile ran"; exit 1; }
          printf '%s\n' '{"nodes": {}, "sources": {}, "errors": []}' > target/catalog.json
          printf '%s\n' \
            '<!doctype html>' \
            '<meta charset="utf-8">' \
            '<title>dbt docs (placeholder)</title>' \
            '<body style="font-family:ui-sans-serif,system-ui,-apple-system;margin:48px auto;max-width:720px;line-height:1.5">' \
            '<h1>Docs placeholder (no Snowflake creds)</h1>' \
            '<p>This PR includes <code>manifest.json</code> for local review. To see full docs, re-run CI with credentials.</p>' \
            '</body>' \
            > target/index.html
          tar -czf dbt-docs.tar.gz target/manifest.json target/catalog.json target/index.html

      - name: Upload docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: dbt-docs
          path: dbt-docs.tar.gz
